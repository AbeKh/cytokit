"0","gsm <- expand.grid(experiments, variants) %>% set_names(c('experiment', 'variant')) %>%"
"0","  mutate(path=str_glue('{data_dir}/{experiment}/output/{variant}/cytometry/data.fcs')) %>%"
"0","  mutate(donor=str_to_upper(str_extract(experiment, '[dD]\\d{2}'))) %>%"
"0","  mutate(replicate=str_extract(experiment, 'Rep[AB]|r[12]')) %>%"
"0","  mutate(replicate=case_when("
"0","    replicate == 'r1' ~ 'RepA',"
"0","    replicate == 'r2' ~ 'RepB',"
"0","    TRUE ~ replicate"
"0","  )) %>% "
"0","  mutate(sample=str_glue('{donor}_{replicate}_{variant}')) %>%"
"0","  as('AnnotatedDataFrame')"
"0","sampleNames(gsm) <- gsm@data$sample"
"0","load_fcs <- function(path, donor, replicate) {"
"0","  fr <- read.FCS(path, column.pattern='PHA', invert.pattern = TRUE)"
"0","  if (donor == 'D22' && replicate == 'RepB'){"
"0","    d <- exprs(fr)"
"0","    mask <- d[,'tilex'] < 4 | d[,'tiley'] > 2"
"0","    print(sprintf('Removing %s rows of %s for file %s', sum(!mask), nrow(fr), path))"
"0","    fr <- Subset(fr, mask)"
"0","  }"
"0","  if (donor == 'D23' && replicate == 'RepB'){"
"0","    d <- exprs(fr)"
"0","    mask <- (d[,'tilex'] != 1 | d[,'tiley'] != 1) & (d[,'tilex'] != 1 | d[,'tiley'] != 2)"
"0","    print(sprintf('Removing %s rows of %s for file %s', sum(!mask), nrow(fr), path))"
"0","    fr <- Subset(fr, mask)"
"0","  }"
"0","  fr"
"0","}"
"0","fsr <- gsm@data %>% select(path, donor, replicate) %>% "
"0","  pmap(load_fcs) %>% set_names(gsm@data$sample)"
"1","[1]"
"1"," ""Removing 949 rows of 6631 for file /Volumes/disk1/cytokit/cellular-marker/20180614_D22_RepB_Tcell_CD4-CD8-DAPI_5by5/output/v00/cytometry/data.fcs"""
"1","
"
"1","[1]"
"1"," ""Removing 939 rows of 7794 for file /Volumes/disk1/cytokit/cellular-marker/20180614_D23_RepB_Tcell_CD4-CD8-DAPI_5by5/output/v00/cytometry/data.fcs"""
"1","
"
"0","fsr <- flowSet(fsr)"
"0","sampleNames(fsr) <- gsm@data$sample"
"0","phenoData(fsr) <- gsm"
"0","chnl <- c(""ciCD4"", ""ciCD8"")"
"0","trans <- transformList(chnl, biexponentialTransform())"
"0","fst <- transform(fsr, trans)"
"0","gs <- GatingSet(fst)"
"2","."
"2","."
"2","."
"2","."
"2","."
"2","."
"2","."
"2","."
"2","done!
"
"0","markernames(gs) <- fsr@colnames %>% set_names(fsr@colnames)"
